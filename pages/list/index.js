import { Button, Table, TableBody, TableRow, TableCell, TableHeader, TableColumn, Avatar, Image } from '@nextui-org/react';
import Head from "next/head";
import { useState } from 'react';
import { FaTrashAlt } from 'react-icons/fa';

export const getServerSideProps = async (context) => {
  const { list, title, description, channelTitle, publishedAt } = context.query;
  let urlData = [];

  if (list && list.indexOf(",") == -1) {
    urlData.push({
      number: 1,
      id: list,
      title: title || "",
      description: description || "",
      channelTitle: channelTitle || "",
      publishedAt: new Date(publishedAt).toUTCString() || "",
    });
  } else {
    list && list.split(",").map((id, index) => {
      urlData.push({
        number: index + 1,
        id,
        title: title && title.split(",")[index] || "",
        description: description && description.split(",")[index] || "",
        channelTitle: channelTitle && channelTitle.split(",")[index] || "",
        publishedAt: publishedAt && new Date(publishedAt.split(",")[index]).toUTCString() || "",
      })   
    });
  }

  return { props: { urlData } };
};

export default function List({ urlData }) {
  const [videoData, setVideoData] = useState(urlData);
  const decodeHTML = (code) => {
    if (typeof window !== "undefined") {
      let text = document.createElement("textarea");
      text.innerHTML = code;
      return text.value
    }
  }

  const deleteFromList = (videoId) => {
    setVideoData((items) => {
      const index = items.findIndex((item) => item.id === videoId);
      if (index !== -1) {
        const updatedItems = [...items];
        updatedItems.splice(index, 1);
        return updatedItems;
      }
      return items;
    });
  }; 

  return (
    <>
      <Head>
        <title>YT Playlist Creator & Sharer</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
      </Head>
      <main className="mt-4 mb-[50px] flex flex-col">
        <h1 className="text-center text-[30px]">My Playlist</h1>
        {urlData.length > 0 ? (
        <Table
              aria-label="Example table with dynamic content"
              className="md:p-6 p-2 mx-3 md:mx-8 my-8 w-100"
          >
            <TableHeader>
              <TableColumn>No.</TableColumn>
              <TableColumn>Video</TableColumn>
              <TableColumn>Title</TableColumn>
              <TableColumn>Uploaded By</TableColumn>
              <TableColumn>Date Uploaded</TableColumn>
              <TableColumn>Action</TableColumn>
            </TableHeader>
            <TableBody items={videoData}>
              { (item) => (
               <TableRow key={item.id}>
                  <TableCell>{item.number}</TableCell>
                  <TableCell><Avatar className="w-40 h-40" src={`http://img.youtube.com/vi/${item.id}/sddefault.jpg`} alt="Youtube Video"/></TableCell>
                  <TableCell>{decodeHTML(item.title)}</TableCell>
                  <TableCell>{decodeHTML(item.channelTitle)}</TableCell>
                  <TableCell>{item.publishedAt}</TableCell>
                  <TableCell>
                    <Button onPress={() => deleteFromList(item.id)} isIconOnly color="danger" aria-label="Remove">
                      <FaTrashAlt />
                    </Button>
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        ) : 
        (<p className="text-center text-gray-500 text-lg">No available playlist</p>)
        }
      </main>
    </>
  );
}
